{
  "name": "RDS Lead Generation - Hot Leads Notification",
  "nodes": [
    {
      "parameters": {
        "path": "/webhook/hot-leads",
        "httpMethod": "POST",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "hot-leads-webhook",
      "name": "Hot Leads Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "hot-leads-notification-webhook"
    },
    {
      "parameters": {
        "functionCode": "// Process hot leads for immediate notification\nconst hotLeads = $json.body.hot_leads || [];\nconst processingSummary = $json.body.processing_summary || {};\nconst timestamp = $json.body.timestamp;\n\nif (hotLeads.length === 0) {\n  return { skip: true, message: 'No hot leads to process' };\n}\n\n// Format hot leads for notifications\nconst formattedLeads = hotLeads.map(lead => {\n  return {\n    company: lead.company,\n    intent_score: lead.intent_score,\n    lead_id: lead.lead_id,\n    vtiger_url: `https://rdsteamglobalpresenceorg.od2.vtiger.com/view/detail?module=Leads&id=${lead.lead_id.replace('2x', '')}`,\n    priority: lead.intent_score >= 95 ? 'URGENT' : 'HIGH'\n  };\n});\n\n// Create Slack message\nconst slackMessage = {\n  text: `ðŸ”¥ *${hotLeads.length} HOT LEAD${hotLeads.length > 1 ? 'S' : ''} DETECTED!*`,\n  blocks: [\n    {\n      type: \"header\",\n      text: {\n        type: \"plain_text\",\n        text: `ðŸ”¥ ${hotLeads.length} Hot Lead${hotLeads.length > 1 ? 's' : ''} - Immediate Action Required`\n      }\n    },\n    {\n      type: \"section\",\n      text: {\n        type: \"mrkdwn\",\n        text: `*Processing Summary:* ${processingSummary.created} leads created, ${hotLeads.length} with intent score â‰¥90`\n      }\n    }\n  ]\n};\n\n// Add each hot lead as a section\nformattedLeads.forEach(lead => {\n  slackMessage.blocks.push({\n    type: \"section\",\n    text: {\n      type: \"mrkdwn\",\n      text: `*${lead.company}*\\nðŸŽ¯ Intent Score: *${lead.intent_score}* (${lead.priority})\\nðŸ“Š <${lead.vtiger_url}|View in VTiger>`\n    },\n    accessory: {\n      type: \"button\",\n      text: {\n        type: \"plain_text\",\n        text: \"View Lead\"\n      },\n      url: lead.vtiger_url,\n      action_id: \"view_lead\"\n    }\n  });\n});\n\nslackMessage.blocks.push({\n  type: \"context\",\n  elements: [\n    {\n      type: \"mrkdwn\",\n      text: `â° Processed: ${new Date(timestamp).toLocaleString()}`\n    }\n  ]\n});\n\nconsole.log('Hot leads notification prepared for:', hotLeads.length, 'leads');\n\nreturn {\n  hot_leads: formattedLeads,\n  slack_message: slackMessage,\n  notification_count: hotLeads.length,\n  timestamp: timestamp\n};"
      },
      "id": "format-notification",
      "name": "Format Hot Leads Notification",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.skip }}",
              "value2": true
            }
          ]
        }
      },
      "id": "skip-check",
      "name": "Skip Notification?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "url": "=https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{\n  \"Content-Type\": \"application/json\"\n}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.slack_message) }}",
        "options": {}
      },
      "id": "slack-notification",
      "name": "Send Slack Alert",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [900, 200]
    },
    {
      "parameters": {
        "url": "http://localhost/leadgen/api/notifications.php",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{\n  \"Content-Type\": \"application/json\"\n}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"type\": \"hot_leads\",\n  \"leads\": {{ JSON.stringify($json.hot_leads) }},\n  \"count\": {{ $json.notification_count }},\n  \"timestamp\": \"{{ $json.timestamp }}\"\n}",
        "options": {}
      },
      "id": "internal-notification",
      "name": "Log Internal Notification",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [900, 400]
    },
    {
      "parameters": {
        "functionCode": "// Create task assignments for hot leads\nconst hotLeads = $json.hot_leads || [];\nconst tasks = [];\n\nhotLeads.forEach(lead => {\n  const urgency = lead.priority === 'URGENT' ? 'within 1 hour' : 'within 4 hours';\n  \n  tasks.push({\n    title: `Follow up: ${lead.company} (Intent: ${lead.intent_score})`,\n    description: `High intent lead - Contact ${urgency}\\nVTiger: ${lead.vtiger_url}`,\n    priority: lead.priority,\n    due_date: lead.priority === 'URGENT' ? \n      new Date(Date.now() + 60*60*1000).toISOString() : // 1 hour\n      new Date(Date.now() + 4*60*60*1000).toISOString(), // 4 hours\n    lead_id: lead.lead_id,\n    company: lead.company\n  });\n});\n\nreturn {\n  tasks: tasks,\n  task_count: tasks.length,\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "create-tasks",
      "name": "Create Follow-up Tasks",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"success\": true,\n  \"message\": \"Hot leads notification sent\",\n  \"notifications_sent\": {{ $json.notification_count || 0 }},\n  \"tasks_created\": {{ $json.task_count || 0 }},\n  \"timestamp\": \"{{ $json.timestamp }}\"\n}"
      },
      "id": "webhook-response",
      "name": "Send Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"success\": true,\n  \"message\": \"No hot leads to process\",\n  \"notifications_sent\": 0,\n  \"timestamp\": \"{{ new Date().toISOString() }}\"\n}"
      },
      "id": "skip-response",
      "name": "Skip Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [900, 500]
    }
  ],
  "connections": {
    "Hot Leads Webhook": {
      "main": [
        [
          {
            "node": "Format Hot Leads Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Hot Leads Notification": {
      "main": [
        [
          {
            "node": "Skip Notification?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skip Notification?": {
      "main": [
        [
          {
            "node": "Send Slack Alert",
            "type": "main",
            "index": 0
          },
          {
            "node": "Log Internal Notification",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Skip Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Slack Alert": {
      "main": [
        [
          {
            "node": "Create Follow-up Tasks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Internal Notification": {
      "main": [
        [
          {
            "node": "Create Follow-up Tasks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Follow-up Tasks": {
      "main": [
        [
          {
            "node": "Send Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {},
  "staticData": {},
  "id": "hot-leads-notification-workflow",
  "meta": {
    "instanceId": "rds-leadgen-local"
  },
  "tags": [
    {
      "createdAt": "2025-09-11T12:00:00.000Z",
      "updatedAt": "2025-09-11T12:00:00.000Z",
      "id": "rds-leadgen",
      "name": "RDS Lead Generation"
    }
  ]
}